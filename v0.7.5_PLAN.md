# v0.7.5 Specification â€” Growth, Moderation & Developer Experience

> **Date**: 2026-02-09 Â· **Version Range**: v0.7.4 â†’ v0.7.5

## Executive Summary

This release delivers **four pillars**: Smart Invites & User Search (growth), Group Command Center (moderation), Ghost Protocol (developer velocity), and Rich Media (delight). The specification is grounded in the existing codebase â€” much of the infrastructure (deep-link handling, URL schemes, QR generation, profile search, NIP-29 member management) already exists and needs to be **wired together and surfaced in the UI** rather than built from scratch.

---

## Codebase Audit â€” What Already Exists

Before defining new work, here is a summary of existing infrastructure that this release builds upon:

| Area | Existing Asset | Status |
|---|---|---|
| **Deep Linking** | `DeepLinkHandler` â€” parses `obscur://`, `nostr:`, and web URLs into route objects | âœ… Built, not wired to UI |
| **URL Schemes** | `URLSchemeHandler` â€” registers `nostr:` and `web+obscur:` protocol handlers + service worker listener | âœ… Built, not activated |
| **QR Codes** | `profile-qr-code.tsx` (display), `qr-scanner.tsx` (scan), `qr-generator.ts`, `qr-scanner-utils.ts` | âœ… Built for user profiles |
| **Invite Manager** | `invite-manager.ts` (50KB) â€” full lifecycle: generate, process, revoke links; manage contact requests | âœ… Built for contacts only |
| **Profile Search** | `ProfileSearchService` â€” NIP-50 relay search + Nostr.band API fallback, trust-scored results | âœ… Built, needs UI |
| **Group Members** | `useNip29Group` â€” exposes `putUser`, `removeUser`, `approveJoin`, `denyJoin` | âœ… Built, basic UI exists |
| **Role Badges** | `group-settings-sheet.tsx` â€” Owner/Mod badges on member list | âœ… Built in settings only |
| **Messaging Types** | `AttachmentKind = "image" \| "video"` â€” needs `"audio"` for voice notes | ğŸ”§ Needs extension |

---

## Pillar 1 â€” ğŸš€ Smart Invites & User Search

### Objective
Remove friction from sharing groups and finding users. Replace manual ID copying with one-click magic links and a live search bar.

### 1.1 Group Invite Links

**Problem**: The "Copy Invite ID" button in `group-settings-sheet.tsx` copies a raw `groupId@hostname` string. Users must manually parse and enter this somewhere.

**Solution**: Generate shareable URLs that, when opened, automatically trigger the "Join Group" flow.

#### Link Format
```
https://obscur-pwa.vercel.app/groups/<groupId>?relay=<relayHostname>
obscur://group/<groupId>?relay=<relayHostname>
```

#### Files to Modify/Create

| Action | File | Change |
|---|---|---|
| MODIFY | [group-settings-sheet.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/groups/components/group-settings-sheet.tsx) | Replace `navigator.clipboard.writeText(...)` with `navigator.share()` using a universal link. Fallback to clipboard for desktop. |
| MODIFY | [deep-link-handler.ts](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/invites/utils/deep-link-handler.ts) | Add `'group'` to `DeepLinkRoute.type` union. Add `parseGroupRoute()` that extracts `groupId` and `relay` from the URL. |
| MODIFY | [url-scheme-handler.ts](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/invites/utils/url-scheme-handler.ts) | Add `groupId` query param handling in `checkCurrentUrl()`. Dispatch a `deeplink` event with `type: 'group'`. |
| NEW | [group-join-dialog.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/groups/components/group-join-dialog.tsx) | A confirmation dialog: "You've been invited to **{groupName}**. [Join / Cancel]". Calls `requestJoin()` from `useNip29Group`. |
| MODIFY | [main-shell.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/main-shell/main-shell.tsx) | Listen for `deeplink` custom events. When `route.type === 'group'`, open the `GroupJoinDialog`. |

#### QR Code Enhancement

| Action | File | Change |
|---|---|---|
| MODIFY | [profile-qr-code.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/invites/components/profile-qr-code.tsx) | Create a `GroupQRCode` variant that encodes the group universal link instead of a user profile. |
| MODIFY | [group-settings-sheet.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/groups/components/group-settings-sheet.tsx) | Add a "Show QR" button next to "Copy Invite ID" that renders `GroupQRCode` in a modal. |

#### Web Share API

```typescript
const shareGroupInvite = async (groupId: string, relayHost: string, groupName: string): Promise<void> => {
    const url = `https://obscur-pwa.vercel.app/groups/${groupId}?relay=${relayHost}`;
    if (navigator.share) {
        await navigator.share({ title: `Join ${groupName} on Obscur`, url });
    } else {
        await navigator.clipboard.writeText(url);
        toast.success("Invite link copied");
    }
};
```

---

### 1.2 User Search & Discovery

**Problem**: `ProfileSearchService` exists but has no UI. Users can only message someone by knowing their full hex public key.

**Solution**: A search bar in the sidebar that queries relays + Nostr.band for profiles by name/NIP-05.

#### Files to Modify/Create

| Action | File | Change |
|---|---|---|
| MODIFY | [search-results-list.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/search/components/search-results-list.tsx) | Build a proper search results UI: avatar, name, NIP-05 badge, mutual count, trust score bar, "Message" and "Connect" action buttons. |
| NEW | [use-profile-search.ts](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/search/hooks/use-profile-search.ts) | A debounced React hook wrapping `ProfileSearchService.searchByName()`. Returns `{ results, isSearching, error }`. |
| MODIFY | [main-shell.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/main-shell/main-shell.tsx) | Add a search input to the sidebar header. On focus, expand into a search overlay showing results from `useProfileSearch`. Clicking a result opens a DM conversation or sends a connection request. |

#### Search Result Card Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Avatar]  Alice                   â­ 80 â”‚
â”‚            alice@nostr.com  âœ“ NIP-05    â”‚
â”‚            3 mutual connections         â”‚
â”‚            [Message]  [Connect]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Pillar 2 â€” ğŸ›¡ï¸ Group Command Center

### Objective
Empower community leaders with comprehensive moderation tools beyond basic add/remove.

### 2.1 Enhanced Member Management

**Current state**: `group-settings-sheet.tsx` already has `putUser`/`removeUser` buttons and role badges. The `useNip29Group` hook exposes these as NIP-29 events.

**Enhancements needed**:

| Action | File | Change |
|---|---|---|
| MODIFY | [group-settings-sheet.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/groups/components/group-settings-sheet.tsx) | **(a)** Add a "Promote to Mod" context menu action per member (calls a new `promoteMember` function). **(b)** Add a "Demote" action for existing mods. **(c)** Add a confirmation dialog before kick/ban actions. **(d)** Display profile names instead of raw hex pubkeys by resolving them via `ProfileSearchService` or a lightweight metadata cache. |
| MODIFY | [use-nip29-group.ts](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/groups/hooks/use-nip29-group.ts) | Add `promoteMember` and `demoteMember` functions. These publish NIP-29 admin action events (Kind 9000 `put-user` with role tags). |

### 2.2 Role Badges in Chat Timeline

**Problem**: Role badges only appear in the settings sheet member list, not in the actual chat messages.

| Action | File | Change |
|---|---|---|
| MODIFY | Chat message bubble component | Add a small badge (ğŸ›¡ï¸ or colored dot) next to the sender name for messages from Owners/Admins. Use the `admins` array from `useNip29Group` state to determine roles. |

### 2.3 Bulk Join Request Actions

**Current state**: Join requests are listed individually with approve/deny buttons.

**Enhancement**:

| Action | File | Change |
|---|---|---|
| MODIFY | [group-settings-sheet.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/groups/components/group-settings-sheet.tsx) | Add "Approve All" / "Deny All" buttons when `joinRequests.length > 1`. These iterate over the array and call `approveJoin`/`denyJoin` for each. |

---

## Pillar 3 â€” ğŸ§ª Ghost Protocol (Simulated Dev Mode)

### Objective
Accelerate local development by simulating multi-user interactions without needing multiple devices, accounts, or a live relay.

### 3.1 Architecture

The dev mode operates as an **in-memory mock layer** that intercepts the `NostrPool` interface. It does **not** touch real relays.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App UI (unchanged)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  NostrPool Interface                â”‚  <-- Abstraction boundary
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Real    â”‚  MockPool (dev only)     â”‚
â”‚  Pool    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚          â”‚  â”‚ Bot 1 (in-memory)   â”‚ â”‚
â”‚          â”‚  â”‚ Bot 2 (in-memory)   â”‚ â”‚
â”‚          â”‚  â”‚ Bot N (in-memory)   â”‚ â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Files to Create

| Action | File | Purpose |
|---|---|---|
| NEW | [mock-pool.ts](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/dev-tools/mock-pool.ts) | Implements `NostrPool` interface. Stores events in memory. Routes publishes to subscribed handlers. |
| NEW | [bot-engine.ts](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/dev-tools/bot-engine.ts) | Creates ephemeral key pairs. Exposes `spawnBot(name)`, `sendMessage(botId, content)`, `joinGroup(botId, groupId)`. Uses `mock-pool` to publish signed events. |
| NEW | [scenarios.ts](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/dev-tools/scenarios.ts) | Preset configurations: `"casual-chat"` (1 msg/5s), `"heavy-traffic"` (10 msg/s), `"mod-action"` (spam â†’ kick sequence). |
| NEW | [dev-panel.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/dev-tools/dev-panel.tsx) | A floating panel UI (bottom-right corner, collapsible). Shows: active bots, scenario selector, network state toggle, event log. |
| NEW | [use-dev-mode.ts](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/dev-tools/use-dev-mode.ts) | Hook that manages dev mode state. Exposes `enableDevMode()`, `disableDevMode()`, `isDevMode`. When enabled, swaps the real pool with `MockPool`. |

### 3.3 Activation

- **Settings > Developer** toggle (only visible in `NODE_ENV === "development"`).
- When enabled, a `<DevPanel />` renders in the app layout.
- The `MockPool` wraps the real pool, so real relay connections are preserved but can be optionally paused.

### 3.4 Network Simulation

```typescript
type NetworkCondition = "online" | "offline" | "slow-3g" | "high-latency";

interface NetworkSimulator {
    setCondition(condition: NetworkCondition): void;
    // "offline" â†’ all publishes silently fail
    // "slow-3g" â†’ 2s delay on all operations
    // "high-latency" â†’ 500ms delay, 10% packet loss
}
```

---

## Pillar 4 â€” ğŸ™ï¸ Rich Media

### 4.1 Voice Notes

#### Recording Flow
1. User holds or taps the microphone button in the message composer.
2. `MediaRecorder` API records audio as `audio/webm` or `audio/mp4`.
3. On release/stop, the blob is uploaded via `useUploadService`.
4. A message is sent with an attachment of kind `"audio"`.

#### Files to Modify/Create

| Action | File | Change |
|---|---|---|
| MODIFY | [messaging types](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/messaging/types/index.ts) | Add `"audio"` to the `AttachmentKind` union type. |
| NEW | [voice-recorder.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/messaging/components/voice-recorder.tsx) | Recording UI: hold-to-record button with recording timer, waveform visualization, cancel (drag left) and send (release). |
| NEW | [audio-player.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/messaging/components/audio-player.tsx) | Inline audio player: waveform display, play/pause toggle, duration/position indicator. |
| MODIFY | Message bubble component | Detect `attachment.kind === "audio"` and render `<AudioPlayer>` instead of the image/video viewer. |

#### Desktop Compatibility
- Tauri: Use `navigator.mediaDevices.getUserMedia()` in the webview (supported in WRY/WebKit).
- Fallback: If mic access fails, hide the voice note button.

### 4.2 Link Previews

#### Flow
1. When a message content includes a URL (regex: `https?://[^\s]+`), extract it.
2. Fetch OpenGraph tags client-side via a lightweight parser (`<meta property="og:title">`, `og:description`, `og:image`).
3. Render a preview card below the message text.

#### Files to Create

| Action | File | Purpose |
|---|---|---|
| NEW | [link-preview-fetcher.ts](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/messaging/lib/link-preview-fetcher.ts) | Extracts URLs from message content, fetches HTML (with CORS proxy fallback), parses OpenGraph meta tags. Caches results in memory. |
| NEW | [link-preview-card.tsx](file:///e:/Web%20Project/experimental-workspace/newstart/apps/pwa/app/features/messaging/components/link-preview-card.tsx) | UI card: favicon + domain, title, description, thumbnail image. |

> [!IMPORTANT]
> Client-side OpenGraph fetching is blocked by CORS on most sites. A lightweight proxy (Cloudflare Worker or `allorigins.win`) is required. Consider reusing the existing Cloudflare Workers infrastructure in `apps/coordination/`.

---

## Implementation Order & Estimates

| # | Pillar | Est. Effort | Dependencies |
|---|---|---|---|
| 1 | **Ghost Protocol** (Dev Tools) | 3â€“4 days | None â€” enables testing everything else |
| 2 | **Smart Invites** (Group Links + User Search) | 3â€“4 days | Existing `DeepLinkHandler`, `InviteManager`, `ProfileSearchService` |
| 3 | **Group Command Center** (Promote/Demote, Bulk Actions, Chat Badges) | 2â€“3 days | Existing `useNip29Group` hook |
| 4 | **Rich Media** (Voice Notes + Link Previews) | 3â€“4 days | Existing `useUploadService`, CORS proxy for link previews |

**Total estimated effort**: ~12â€“15 days

---

## Verification Plan

### Automated Tests
- **Ghost Protocol**: Unit tests for `MockPool` event routing, `BotEngine` message signing, and scenario timing.
- **Smart Invites**: Unit tests for `parseGroupRoute()` in `DeepLinkHandler`. Integration test for the full flow: generate link â†’ parse â†’ open join dialog.
- **Group Management**: Unit tests for `promoteMember`/`demoteMember` event construction.

### Manual / Browser Verification
- **Smart Invites**: Open a generated link in a fresh browser tab â†’ verify `GroupJoinDialog` appears.
- **QR Codes**: Use the QR scanner component to scan a group QR â†’ verify join flow triggers.
- **User Search**: Type 3+ characters in the search bar â†’ verify results appear within 3s.
- **Voice Notes**: Record a 5s audio clip â†’ verify upload â†’ verify playback in the timeline.
- **Link Previews**: Send a message containing `https://github.com` â†’ verify the preview card renders.
- **Dev Mode**: Enable dev mode â†’ spawn 3 bots â†’ run "casual-chat" scenario â†’ verify messages appear in the timeline.

### Build Verification
```bash
pnpm -C apps/pwa build
```
