User Search & Invitation System Redesign - v0.3.0
Problem Analysis
Current Issues
Technical Barrier: Users must know and enter 64-character hex public keys or npub strings
No User Verification: App creates chat even when recipient doesn't exist on any relay
No Invitation Flow: Messages sent immediately with no acceptance mechanism
Relay Mismatch: Messages fail because sender and recipient use different relays
No Spam Protection: Anyone can add anyone without consent or verification
Root Causes
Missing NIP-05 (DNS-based identity) support
No implementation of connection request pattern
Poor relay discovery (NIP-65 partially implemented)
No Web of Trust or reputation system
Proposed Solution: Multi-Method Discovery + Request Flow
Phase 1: Enhanced User Discovery (Priority: HIGH)
1.1 NIP-05 Verification Support
Enable users to find each other by human-readable identifiers like alice@example.com.

Implementation:

Add NIP-05 resolver to search flow
Query https://example.com/.well-known/nostr.json?name=alice to get pubkey
Verify the pubkey matches the returned data
Display verification badge for NIP-05 users
Files to Create/Modify:

[NEW] 
apps/pwa/app/features/profile/utils/nip05-resolver.ts
[MODIFY] 
new-chat-dialog.tsx
1.2 Profile Metadata Search
Search for users by display name across connected relays.

Implementation:

Query Kind 0 (metadata) events with name filters
Use fuzzy matching for user-entered names
Show results with avatar, name, NIP-05, and relay count
Sort by relevance and verification status
Files to Create/Modify:

[NEW] 
apps/pwa/app/features/search/services/profile-search-service.ts
[NEW] 
apps/pwa/app/features/search/components/search-results-list.tsx
1.3 QR Code Invite Sharing
Allow users to share their profile via QR codes containing nprofile with relay hints.

Implementation:

Generate QR code with nprofile1... (includes pubkey + relay hints)
Add camera scanner for QR codes
Auto-populate "New Chat" dialog when scanned
Files to Create/Modify:

[NEW] 
apps/pwa/app/features/invites/components/qr-code-generator.tsx
[NEW] 
apps/pwa/app/features/invites/components/qr-code-scanner.tsx
Phase 2: Connection Request Flow (Priority: HIGH)
Replace instant chat creation with a proper invitation system.

2.1 Request State Machine
[Unknown User] → [Send Request] → [Pending] → [Accepted] ✓
                                           ↘ [Declined] ✗
Implementation:

Add connection-requests collection to storage
Track request state: pending, accepted, rejected
Send initial DM with special "request" flag (could use Kind 24133 - Channel Create Request or custom tag)
Recipient sees request in dedicated "Requests" inbox
Only create conversation after acceptance
Files to Create/Modify:

[NEW] 
apps/pwa/app/features/contacts/services/connection-request-service.ts
[MODIFY] 
apps/pwa/app/features/messaging/hooks/use-requests-inbox.ts
[NEW] 
apps/pwa/app/features/contacts/components/connection-request-card.tsx
2.2 Initial Request Message
When sending a request, allow user to include a short message explaining why they want to connect.

UI Flow:

User searches for someone
Clicks "Send Connection Request"
Modal appears: "Introduce yourself (optional)" with 280-char limit
System sends request + intro message
Recipient sees intro in request card
Files to Create/Modify:

[NEW] 
apps/pwa/app/features/contacts/components/send-request-dialog.tsx
Phase 3: Enhanced Trust & Privacy UI (Priority: MEDIUM)
3.1 "Stranger Message" Warning
Protect users from unwanted interactions by displaying a warning banner for messages from non-accepted peers.

Implementation:

Add isPeerAccepted logic to 
main-shell.tsx
 and pass it to 
ChatView
.
Create 
StrangerWarningBanner
 component with "Accept", "Ignore", and "Block" actions.
Blur or hide media content for unaccepted peers (Optional/Future).
Files to Create/Modify:

[MODIFY] 
apps/pwa/app/features/messaging/components/chat-view.tsx
[MODIFY] 
apps/pwa/app/features/main-shell/main-shell.tsx
3.2 Safety & Privacy Settings Overhaul
Consolidate trust, mute, and block management into a premium "Safety & Privacy" experience.

Implementation:

Move Blocklist management into 
TrustSettingsPanel
.
Add "Trust Levels" explanation and visualization.
Implement "Bulk Actions" for managing requests (Optional/Future).
Files to Create/Modify:

[MODIFY] 
apps/pwa/app/features/messaging/components/trust-settings-panel.tsx
[MODIFY] 
apps/pwa/app/settings/page.tsx
Phase 4: Improved Search UX (Priority: MEDIUM)
4.1 Unified Search Interface
Combine "Verify" and "Search" into a single intelligent action.

Logic in 
handleUnifiedSearch
:

Detect Input Type:
@ symbol → NIP-05 resolution.
npub1 / nprofile1 / 64-hex → Individual user verification (Kind 0 fetch).
Text → Global metadata search via ProfileSearchService.searchByName.
UI Updates:
Single "Search" button replaces separate "Verify" and "Search".
Pressing "Enter" triggers the appropriate search logic.
Loading states unified via isSearching.
4.2 Rich Profile Search Results
Enhance 
SearchResultsList
 with more context and trust signals.

Implementation:

Show Bio: Truncated about text in result items.
Trust Indicator: Display "Accepted" badge if peer is already in trust list.
Visual Polish: Improved spacing, subtle hover states, and premium typography.
Empty State: Friendly "No matches found" with suggested relay tips if search yields 0 results.
Files to Modify:

[MODIFY] 
apps/pwa/app/features/messaging/components/new-chat-dialog.tsx
[MODIFY] 
apps/pwa/app/features/search/components/search-results-list.tsx
Phase 5: Web of Trust & Mutual Connections (Priority: MEDIUM)
Enhance search results with social context by calculating mutual connections and trust scores.

5.1 Social Graph Service
Implement a service to manage Nostr Kind 3 (Contact List) events and build a local representation of the social graph.

Implementation:

Fetch Kind 3: Retrieve contact lists for the current user and target profiles during search.
Mutual Calculation: Logic to find the intersection of the user's following list and the target's following list.
Caching: Store contact lists in IndexedDB to avoid repeated relay queries.
Files to Create/Modify:

[NEW] 
apps/pwa/app/features/social-graph/services/social-graph-service.ts
[MODIFY] 
apps/pwa/app/features/search/services/profile-search-service.ts
5.2 Trust Score & UI Integration
Add visual trust indicators to 
SearchResultsList
.

Implementation:

Trust Score Algorithm:
+100: Already in local "Trusted" list.
+20 per Mutual: Up to 3 mutual connections.
+20: NIP-05 verified.
UI Display:
Show "X Mutuals" in profile cards.
Add a subtle "Trust Score" progress bar or confidence indicator.
Files to Modify:

[MODIFY] 
apps/pwa/app/features/search/components/search-results-list.tsx
Phase 6: Relay Improvements & Discovery (Priority: LOW)
6.1 Automatic Relay Hints
When sending requests, include your write relays in the event (NIP-65).

6.2 Relay Suggestions
Suggest popular relays if user search fails to return results.

User Review Required
IMPORTANT

Breaking Changes

Connection requests will be stored locally before creating conversations
Users may need to accept pending requests from v0.2.x manually after upgrade
New permission flow may confuse existing users who expect instant chat
WARNING

Spam Prevention Trade-offs

Proof of Work might slow down request sending on low-end devices
Web of Trust scoring requires building social graph (initial cold start)
Rate limiting might frustrate power users connecting with many people
Verification Plan
Automated Tests
NIP-05 Resolution: Mock DNS queries and verify pubkey extraction
Connection Request Flow: Test state transitions (pending → accepted/rejected)
PoW Mining: Verify event difficulty meets threshold
Rate Limiting: Ensure limits enforced correctly
Manual Verification
User Discovery: Search by NIP-05, name, QR code, and verify correct results
Request Flow: Send request → recipient sees it → accept → chat created
Spam Handling: Block/report user → verify they can't send more requests
Relay Discovery: Use nprofile with hints → verify auto-connection
Browser Testing
Test QR scanner on mobile PWA
Test request notifications
Test search performance with 100+ profiles