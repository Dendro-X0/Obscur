name: Tauri Desktop Build & Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write  # Changed from 'read' to 'write' to allow creating releases

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.releaseId }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create Release
        id: create-release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Obscur Desktop ${{ github.ref_name }}"
          releaseBody: "üéâ New Release available for ${{ github.ref_name }}!"
          releaseDraft: true
          prerelease: false

  build:
    needs: create-release
    name: Build desktop (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    env:
      CI: true
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.4
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: >-
          sudo apt-get update &&
          sudo apt-get install -y
          libwebkit2gtk-4.1-dev
          libgtk-3-dev
          libappindicator3-dev
          librsvg2-dev
          patchelf
          build-essential
          pkg-config
          libssl-dev

      - name: Install workspace deps
        run: pnpm install --frozen-lockfile

      - name: Sync version across workspace
        run: pnpm version:sync

      - name: Install desktop deps
        run: pnpm -C apps/desktop install

      - name: Prepare PWA for Static Export
        shell: bash
        run: |
          echo "Disabling dynamic routes/APIs for static export..."
          # Hide API directory
          if [ -d "apps/pwa/app/api" ]; then
            mv apps/pwa/app/api apps/pwa/app/_api_hidden
          fi
          
          # Disable specific route files
          for file in \
            apps/pwa/app/api-backup/upload/route.ts \
            apps/pwa/app/icon-192.png/route.ts \
            apps/pwa/app/icon-512.png/route.ts \
            apps/pwa/app/sw.js/route.ts \
            apps/pwa/app/apple-touch-icon.png/route.ts \
            apps/pwa/app/invite/page.tsx \
            apps/pwa/app/invite/[code]/page.tsx \
            apps/pwa/app/groups/[groupId]/page.tsx
          do
            if [ -f "$file" ]; then
              mv "$file" "$file.ignored"
            fi
          done

      - name: Build PWA (static export for desktop)
        run: pnpm -C apps/pwa build
        env:
          NODE_ENV: production
          TAURI_BUILD: true

      - name: Verify PWA build output
        run: |
          echo "Checking PWA build output..."
          ls -la apps/pwa/out || echo "‚ö†Ô∏è PWA out directory not found"
          if [ -f "apps/pwa/out/index.html" ]; then
            echo "‚úÖ PWA build successful - index.html found"
            # Verify it contains "Obscur" not "Nostr Messenger"
            if grep -q "Obscur" apps/pwa/out/index.html; then
              echo "‚úÖ PWA contains correct branding (Obscur)"
            else
              echo "‚ùå PWA still contains old branding"
              exit 1
            fi
          else
            echo "‚ùå PWA build failed - index.html not found"
            exit 1
          fi
        shell: bash

      - name: Build desktop app and upload to release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_WINDOWS_CERTIFICATE_THUMBPRINT: ${{ secrets.TAURI_SIGNING_WINDOWS_CERTIFICATE_THUMBPRINT }}
        with:
          projectPath: apps/desktop
          tagName: ${{ github.ref_name }}
          releaseId: ${{ needs.create-release.outputs.release_id }}
          releaseDraft: true
          prerelease: false
          includeDebug: false
          includeRelease: true
          args: --verbose

      - name: Upload build artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: obscur-desktop-${{ matrix.os }}
          path: apps/desktop/src-tauri/target/release/bundle
          retention-days: 30
